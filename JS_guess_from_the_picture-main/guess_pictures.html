<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Угадай персонажа!</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <!-- Стили оформления игрового экрана и элементов управления -->
</head>
<style>
    body {
        margin: 0;
        background-image: url("backgrounds/got01.jpg");
        background-size: cover;
        background-position: center;
        color: #e8e6e3;
        font-family: "Merriweather", serif;
        min-height: 100vh;
    }
    .main {
        max-width: 920px;
        margin: 32px auto;
        text-align: center;
        padding: 24px;
        background: rgba(0, 0, 0, 0.55);
        border: 1px solid rgba(202, 165, 102, 0.4);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        border-radius: 12px;
        backdrop-filter: blur(2px);
    }
    h1 {
        font-family: "Cinzel", serif;
        letter-spacing: 1px;
        margin: 0 0 8px 0;
        color: #f0e6d2;
    }
    .got-btn.btn {
        color: #111;
        background: linear-gradient(180deg, #d5b77a, #b59353);
        border: 1px solid #caa566;
    }
    .got-btn.btn:hover { filter: brightness(1.08); }
    .got-btn.btn:active { transform: translateY(1px); }
    .my_image {
        width: 360px;
        max-width: 100%;
        border-radius: 10px;
        border: 2px solid rgba(202, 165, 102, 0.6);
        box-shadow: 0 10px 25px rgba(0,0,0,0.45);
    }
    #buttons-container {
        background: rgba(0, 0, 0, 0.35);
        padding: 20px;
        border-radius: 10px;
        border: 1px solid rgba(202, 165, 102, 0.25);
    }
    footer {
        opacity: 0.8;
        font-size: 14px;
        margin-top: 12px;
    }
</style>
<body>
    <!-- Весь контент игры оборачиваем в контейнер Bootstrap, чтобы центрировать блок -->
    <div class="container">
        <div class="main">
            <h1>Угадай персонажа из «Игры престолов»</h1>
            <!-- Панель управления музыкой, озвучкой и фильтрами по полу -->
            <div id="controls" class="d-flex align-items-center justify-content-center gap-2 my-2 flex-wrap">
                <button id="music-toggle" class="btn got-btn" aria-pressed="false">Музыка: выкл</button>
                <button id="speech-toggle" class="btn got-btn" aria-pressed="false">Голос: выкл</button>
                <div class="btn-group ms-1" role="group" aria-label="Выбор пола">
                  <input type="radio" class="btn-check" name="genderOptions" id="gender-both" autocomplete="off" value="both">
                  <label class="btn btn-sm btn-outline-light" for="gender-both">Оба пола</label>

                  <input type="radio" class="btn-check" name="genderOptions" id="gender-f" autocomplete="off" value="f">
                  <label class="btn btn-sm btn-outline-light" for="gender-f">Женщины</label>

                  <input type="radio" class="btn-check" name="genderOptions" id="gender-m" autocomplete="off" value="m">
                  <label class="btn btn-sm btn-outline-light" for="gender-m">Мужчины</label>
                </div>
            </div>
            <!-- Верхняя строка с текущей статистикой и кнопкой перезапуска -->
            <div class="row g-3 align-items-center mb-3">
                <div class="col-12 col-md-6">
                    <h2 class="h5 m-0" id="count_pictures"></h2>
                    <div class="small opacity-75" aria-live="polite">
                        <span id="score">0</span> из <span id="attempts">0</span> попыток
                    </div>
                </div>
                <div class="col-12 col-md-6 text-md-end">
                    <button id="restart-btn" class="btn btn-sm btn-outline-light">Перезапустить</button>
                </div>
            </div>

            <!-- Блок для вывода текущей картинки персонажа -->
            <div class="row g-4 justify-content-center mb-3">
                <div class="col-12 text-center">
                    <div id="image-container"></div>
                </div>
            </div>
            <!-- Здесь динамически появляются кнопки-варианты ответов -->
            <div id="buttons-container" class="row g-2 justify-content-center"></div>

            <footer class="mt-3">Разработчики: Бадалин Андрей и Трембач Роман<br>2025 г.</footer>

            <audio id="tada-sound" preload="auto">
                <source src="sounds/jg-032316-sfx-elearning-correct-answer-sound-1.mp3" type="audio/mpeg">
            </audio>
            <audio id="wrong-sound" preload="auto">
                <source src="sounds/jg-032316-sfx-feedback-incorrect-6.mp3" type="audio/mpeg">
            </audio>
            <audio id="bg-music" loop>
                <source src="sounds/0cc79e43a41cbe1.mp3" type="audio/mpeg">
            </audio>
        </div>
    </div>

    <!-- Модальное окно с итогами игры -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="resultModalLabel">Результаты</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p class="mb-1">Правильных ответов: <strong id="result-correct">0</strong></p>
            <p class="mb-0">Всего попыток: <strong id="result-total">0</strong></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            <button type="button" id="modal-restart" class="btn got-btn">Перезапустить</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- ДАННЫЕ И ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---
      // Явная модель данных: name, gender: 'm'|'f', src: путь к изображению
      const characters = [
        { name: 'Arya', gender: 'f', src: 'arya.jpg' },
        { name: 'Bran', gender: 'm', src: 'bran.jpg' },
        { name: 'Brienna', gender: 'f', src: 'brienna.jpg' },
        { name: 'Dany', gender: 'f', src: 'dany.jpg' },
        { name: 'Drogo', gender: 'm', src: 'drogo.jpg' },
        { name: 'Harry', gender: 'm', src: 'harry.jpg' },
        { name: 'Hodor', gender: 'm', src: 'hodor.jpg' },
        { name: 'Jendry', gender: 'm', src: 'jendry.jpg' },
        { name: 'Joffrey', gender: 'm', src: 'joffrey.jpg' },
        { name: 'Jon', gender: 'm', src: 'jon.jpg' },
        { name: 'Loras', gender: 'm', src: 'loras.jpg' },
        { name: 'Margaery', gender: 'f', src: 'margaery.jpg' },
        { name: 'Mel', gender: 'f', src: 'mel.jpg' },
        { name: 'Ned', gender: 'm', src: 'ned.jpg' },
        { name: 'Oberyn', gender: 'm', src: 'oberyn.jpg' },
        { name: 'Ramsey', gender: 'm', src: 'ramsey.jpg' },
        { name: 'Renly', gender: 'm', src: 'renly.jpg' },
        { name: 'Robb', gender: 'm', src: 'robb.jpg' },
        { name: 'Sam', gender: 'm', src: 'sam.jpg' },
        { name: 'Sansa', gender: 'f', src: 'sansa.jpg' },
        { name: 'Theon', gender: 'm', src: 'theon.jpg' },
        { name: 'Tormund', gender: 'm', src: 'tormund.jpg' },
        { name: 'Tyrion', gender: 'm', src: 'tyrion.jpg' },
        { name: 'Cersei', gender: 'f', src: 'cersei.jpg' },
        { name: 'Jaime', gender: 'm', src: 'jaime.jpg' },
        { name: 'Tywin', gender: 'm', src: 'tywin.jpg' },
        { name: 'Varys', gender: 'm', src: 'varys.jpg' },
        { name: 'Bronn', gender: 'm', src: 'bronn.jpg' },
        { name: 'Ygritte', gender: 'f', src: 'ygritte.jpg' }
      ];

      // Перетасовка (Fisher–Yates)
      // Создаёт новую перемешанную копию массива, чтобы порядок вопросов был случайным
      function shuffle(arr) {
        const a = arr.slice();
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      // --- ПЕРЕМЕННЫЕ СОСТОЯНИЯ ---
      // deck: текущий набор карточек (после фильтрации по полу и перемешивания)
      let deck = [];
      let roundIndex = 0;
      let score = 0;
      let attempts = 0;

      // --- НАСТРОЙКА ЗВУКА ---
      // Получаем ссылки на элементы аудио и кнопок управления
      const tada = document.getElementById('tada-sound');
      const wrong = document.getElementById('wrong-sound');
      const bgAudio = document.getElementById('bg-music');
      const musicToggle = document.getElementById('music-toggle');
      const speechToggle = document.getElementById('speech-toggle');
      let musicEnabled = (localStorage.getItem('bgMusicEnabled') === null)
        ? true : localStorage.getItem('bgMusicEnabled') === 'true';
      let musicInitialized = false;

      // При первом взаимодействии запускаем музыку (чтобы не нарушать ограничения браузера)
      function ensureMusicStarted() {
        if (musicInitialized) return;
        musicInitialized = true;
        if (musicEnabled) {
          bgAudio.volume = 0.35;
          const p = bgAudio.play();
          if (p && typeof p.catch === 'function') p.catch(() => {});
        }
      }

      // Перерисовываем подпись кнопки вкл/выкл музыки согласно текущему состоянию
      function updateMusicToggleLabel() {
        musicToggle.setAttribute('aria-pressed', musicEnabled ? 'true' : 'false');
        musicToggle.textContent = musicEnabled ? 'Музыка: вкл' : 'Музыка: выкл';
      }

      musicToggle.addEventListener('click', () => {
        musicEnabled = !musicEnabled;
        localStorage.setItem('bgMusicEnabled', String(musicEnabled));
        updateMusicToggleLabel();
        if (musicEnabled) { ensureMusicStarted(); bgAudio.play(); } else { bgAudio.pause(); }
      });

      // --- СИНТЕЗ РЕЧИ (WEB SPEECH API) ---
      // Настраиваем переключатель озвучки и функции произношения текста
      let voiceEnabled = (localStorage.getItem('voiceEnabled') === null)
        ? true : localStorage.getItem('voiceEnabled') === 'true';
      function updateSpeechToggleLabel() {
        speechToggle.setAttribute('aria-pressed', voiceEnabled ? 'true' : 'false');
        speechToggle.textContent = voiceEnabled ? 'Голос: вкл' : 'Голос: выкл';
      }
      let voices = [];
      function refreshVoices() {
        if (!('speechSynthesis' in window)) return;
        voices = window.speechSynthesis.getVoices();
      }
      if ('speechSynthesis' in window) {
        refreshVoices();
        window.speechSynthesis.onvoiceschanged = refreshVoices;
      }
      function pickRuVoice() {
        if (!voices || !voices.length) return null;
        return voices.find(v => (v.lang || '').toLowerCase().startsWith('ru'))
            || voices.find(v => (v.name || '').toLowerCase().includes('russian'))
            || null;
      }
      // Озвучиваем переданный текст, если синтез речи разрешён и поддерживается браузером
      function speak(text) {
        if (!voiceEnabled || !('speechSynthesis' in window)) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'ru-RU';
        const v = pickRuVoice();
        if (v) u.voice = v;
        u.rate = 1.0;
        u.pitch = 1.0;
        u.volume = 1.0;
        try { window.speechSynthesis.cancel(); } catch(e) {}
        window.speechSynthesis.speak(u);
      }
      speechToggle.addEventListener('click', () => {
        voiceEnabled = !voiceEnabled;
        localStorage.setItem('voiceEnabled', String(voiceEnabled));
        updateSpeechToggleLabel();
        if (voiceEnabled) speak('Озвучивание включено');
      });

      // --- ПОСТРОЕНИЕ ВАРИАНТОВ ОТВЕТА ---
      // Собираем четыре кнопки, стараясь подобрать персонажей того же пола, что и правильный
      function buildOptions(correct) {
        const poolBase = deck;
        const sameGender = poolBase.filter(c => c.gender === correct.gender && c !== correct);
        const pool = shuffle(sameGender).slice(0, 3);
        while (pool.length < 3) {
          const filler = shuffle(poolBase.filter(c => c !== correct && !pool.includes(c)))[0];
          if (!filler) break;
          pool.push(filler);
        }
        const opts = shuffle([correct, ...pool.slice(0, 3)]);
        return opts;
      }

      // --- ОТРИСОВКА РАУНДА ---
      // Показать картинку текущего персонажа и сгенерировать кнопки-ответы
      function renderRound() {
        if (roundIndex >= deck.length) {
          document.getElementById('result-correct').textContent = String(score);
          document.getElementById('result-total').textContent = String(attempts);
          const modal = new bootstrap.Modal(document.getElementById('resultModal'));
          modal.show();
          // Озвучивание только в конце: сколько правильных ответов
          speak(`Игра окончена. Правильных ответов ${score}.`);
          return;
        }

        const current = deck[roundIndex];
        const imgWrap = document.getElementById('image-container');
        imgWrap.innerHTML = '';
        const img = document.createElement('img');
        img.className = 'my_image';
        img.src = current.src;
        img.alt = current.name;
        img.onerror = function () { this.onerror = null; this.src = 'backgrounds/got01.jpg'; };
        imgWrap.appendChild(img);

        const options = buildOptions(current);
        const btns = options.map(opt => {
          const isCorrect = opt === current;
          return `<div class="col-12 col-sm-6 col-lg-6 d-grid">` +
                 `<button class="btn got-btn my_button" data-correct="${isCorrect}">${opt.name}</button>` +
                 `</div>`;
        }).join('');
        document.getElementById('buttons-container').innerHTML = btns;

        // Каждая кнопка проверяет себя и запускает следующий раунд
        document.querySelectorAll('#buttons-container button').forEach(btn => {
          btn.addEventListener('click', () => {
            ensureMusicStarted();
            attempts += 1;
            document.getElementById('attempts').textContent = String(attempts);
            const ok = btn.getAttribute('data-correct') === 'true';
            if (ok) {
              score += 1;
              document.getElementById('score').textContent = String(score);
              tada.currentTime = 0; tada.play();
            } else {
              wrong.currentTime = 0; wrong.play();
            }
            roundIndex += 1;
            renderRound();
          });
        });
      }

      // Вспомогательный перевод кодов пола в человеко-читаемую подпись
      function genderLabel(code) {
        if (code === 'm') return 'мужчины';
        if (code === 'f') return 'женщины';
        return 'оба пола';
      }

      // --- СТАРТ И СБРОС ИГРЫ ---
      // Собираем новую колоду, фильтруем по полу и сбрасываем счётчики
      function startGame() {
        const selectedGender = (localStorage.getItem('selectedGender') ?? 'both');
        const source = characters.filter(c => selectedGender === 'both' ? true : c.gender === selectedGender);
        deck = shuffle(source.length ? source : characters);
        roundIndex = 0;
        score = 0;
        attempts = 0;
        document.getElementById('score').textContent = '0';
        document.getElementById('attempts').textContent = '0';
        document.getElementById('count_pictures').textContent = 'Персонажей (' + genderLabel(selectedGender) + '): ' + deck.length;
        renderRound();
      }

      function resetGame() {
        startGame();
      }

      // Подставляем актуальное состояние радио-кнопок в зависимости от значения в localStorage
      function syncGenderUI() {
        const selectedGender = (localStorage.getItem('selectedGender') ?? 'both');
        const map = { both: 'gender-both', m: 'gender-m', f: 'gender-f' };
        const id = map[selectedGender] || 'gender-both';
        const input = document.getElementById(id);
        if (input) input.checked = true;
      }

      // Навешиваем обработчики на переключатели пола. При смене фильтра игра перезапускается
      function wireGenderHandlers() {
        ['gender-both','gender-m','gender-f'].forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('change', () => {
            const v = el.value; // both | m | f
            localStorage.setItem('selectedGender', v);
            resetGame();
          });
        });
      }

      // Кнопка на странице просто перезапускает игру и, при необходимости, включает музыку
      document.getElementById('restart-btn').addEventListener('click', () => {
        ensureMusicStarted();
        resetGame();
      });
      // Кнопка в модальном окне закрывает его и запускает новую игру
      document.getElementById('modal-restart').addEventListener('click', () => {
        const modalEl = document.getElementById('resultModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();
        resetGame();
      });

      // --- ТОЧКА ВХОДА ---
      // Когда документ готов, восстанавливаем настройки и запускаем игру
      document.addEventListener('DOMContentLoaded', () => {
        updateMusicToggleLabel();
        updateSpeechToggleLabel();
        if (musicEnabled) bgAudio.volume = 0.35;
        if (!localStorage.getItem('selectedGender')) localStorage.setItem('selectedGender', 'both');
        syncGenderUI();
        wireGenderHandlers();
        startGame();
      });
    </script>
</body>
</html>